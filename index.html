<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- CRITICAL: Meta tags espec√≠ficos para iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  
  <title>Ticket de Venta</title>
  <style>
    /* =============================================
       RESET COMPLETO
    ============================================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      color-adjust: exact;
    }
    
    /* =============================================
       CONFIGURACI√ìN DE P√ÅGINA (@page)
       M√öLTIPLES VARIANTES PARA COMPATIBILIDAD
    ============================================= */
    
    /* Variante principal - 80mm */
    @page {
      size: 80mm auto;
      margin: 0mm;
      padding: 0mm;
    }
    
    /* Fallback para navegadores que no soportan tama√±o en mm */
    @page {
      size: 3.15in auto; /* 80mm = 3.15 pulgadas */
      margin: 0;
    }
    
    /* Espec√≠fico para iOS/Safari */
    @page {
      margin: 0;
    }
    
    /* =============================================
       ESTILOS BASE DEL BODY
    ============================================= */
    html {
      width: 100%;
      height: 100%;
    }
    
    body {
      font-family: 'Courier New', 'Consolas', monospace;
      background: #f0f0f0;
      padding: 10px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* =============================================
       CONTENEDOR DEL TICKET
    ============================================= */
    .ticket {
      width: 80mm;
      max-width: 100%;
      background: white;
      padding: 5mm;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin: 0 auto 20px;
      font-size: 11pt;
      line-height: 1.4;
    }
    
    /* =============================================
       HEADER
    ============================================= */
    .header {
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px dashed #000;
      padding-bottom: 8px;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: block;
      object-fit: cover;
    }
    
    .empresa-nombre {
      font-size: 16pt;
      font-weight: bold;
      margin: 5px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .empresa-info {
      font-size: 10pt;
      line-height: 1.4;
    }
    
    .empresa-info div {
      margin: 2px 0;
    }
    
    /* =============================================
       INFORMACI√ìN DE FACTURA
    ============================================= */
    .factura-info {
      margin: 10px 0;
      font-size: 10pt;
    }
    
    .factura-info div {
      margin: 4px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .factura-info strong {
      min-width: 80px;
      font-weight: bold;
    }
    
    .factura-info span {
      text-align: right;
      flex: 1;
    }
    
    /* =============================================
       TABLA DE PRODUCTOS
    ============================================= */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 10pt;
    }
    
    thead {
      border-bottom: 2px solid #000;
    }
    
    th {
      padding: 5px 2px;
      text-align: left;
      font-weight: bold;
      background: none;
    }
    
    tbody tr {
      border-bottom: 1px dashed #999;
    }
    
    td {
      padding: 8px 2px;
      vertical-align: top;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    /* Ajuste de anchos de columnas */
    table th:nth-child(1),
    table td:nth-child(1) {
      width: 50%;
    }
    
    table th:nth-child(2),
    table td:nth-child(2) {
      width: 20%;
      text-align: center;
    }
    
    table th:nth-child(3),
    table td:nth-child(3) {
      width: 30%;
      text-align: right;
    }
    
    /* =============================================
       TOTALES
    ============================================= */
    .total-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #000;
      font-size: 11pt;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      align-items: center;
    }
    
    .total-row.main {
      font-size: 14pt;
      font-weight: bold;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #000;
    }
    
    .total-row span:first-child {
      font-weight: 600;
    }
    
    .total-row span:last-child {
      text-align: right;
    }
    
    /* =============================================
       FOOTER
    ============================================= */
    .footer {
      text-align: center;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #000;
      font-size: 9pt;
    }
    
    .footer p {
      margin: 4px 0;
    }
    
    .footer strong {
      font-size: 10pt;
    }
    
    /* =============================================
       BOTONES (Solo pantalla)
    ============================================= */
    .btn-container {
      text-align: center;
      margin: 20px 0;
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
      max-width: 400px;
    }
    
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 140px;
    }
    
    .btn:active {
      transform: scale(0.95);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .btn-print {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }
    
    .btn-rawbt {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }
    
    .btn-close {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
    }
    
    /* Mensaje de ayuda para iOS */
    .ios-help {
      background: #FFF3CD;
      border: 2px solid #FFC107;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      font-size: 13px;
      line-height: 1.6;
      max-width: 400px;
      display: none;
    }
    
    .ios-help strong {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #F57C00;
    }
    
    .ios-help ol {
      margin: 10px 0 10px 20px;
      padding: 0;
    }
    
    .ios-help li {
      margin: 5px 0;
    }
    
    /* =============================================
       MEDIA QUERY PARA IMPRESI√ìN
    ============================================= */
    @media print {
      /* Resetear todo el entorno de impresi√≥n */
      html, body {
        width: 80mm !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        overflow: visible !important;
      }
      
      body {
        display: block !important;
      }
      
      /* Ticket ocupa todo el espacio */
      .ticket {
        width: 80mm !important;
        max-width: 80mm !important;
        min-width: 80mm !important;
        margin: 0 !important;
        padding: 3mm 2mm !important;
        box-shadow: none !important;
        page-break-after: auto;
        page-break-before: auto;
        page-break-inside: avoid;
      }
      
      /* Ocultar botones y ayuda */
      .btn-container,
      .ios-help {
        display: none !important;
      }
      
      /* Evitar saltos de p√°gina */
      .header, 
      .factura-info, 
      table, 
      .total-section, 
      .footer {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      /* Asegurar bordes visibles */
      .header,
      .footer,
      table thead,
      tbody tr {
        border-color: #000 !important;
      }
      
      /* Optimizar fuentes para impresi√≥n t√©rmica */
      body, .ticket {
        font-size: 10pt !important;
        line-height: 1.3 !important;
      }
      
      .empresa-nombre {
        font-size: 14pt !important;
      }
      
      .total-row.main {
        font-size: 12pt !important;
      }
      
      /* Forzar colores exactos */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      
      /* Logos e im√°genes optimizadas */
      .logo {
        max-width: 50px !important;
        max-height: 50px !important;
        page-break-inside: avoid;
      }
      
      /* Sin m√°rgenes adicionales en tabla */
      table {
        margin: 8px 0 !important;
      }
    }
    
    /* =============================================
       RESPONSIVE M√ìVIL
    ============================================= */
    @media screen and (max-width: 400px) {
      body {
        padding: 5px;
      }
      
      .ticket {
        width: 100%;
        padding: 10px;
      }
      
      .btn-container {
        padding: 0 10px;
      }
      
      .btn {
        flex: 1;
        min-width: 100px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      .ios-help {
        font-size: 12px;
        padding: 12px;
      }
    }
    
    /* =============================================
       ESTILOS ESPEC√çFICOS PARA iOS
    ============================================= */
    @supports (-webkit-touch-callout: none) {
      /* Solo en Safari/iOS */
      .ticket {
        -webkit-text-size-adjust: 100%;
      }
      
      .ios-help {
        display: block !important;
      }
      
      @media print {
        html, body {
          -webkit-print-color-adjust: exact !important;
        }
        
        .ticket {
          -webkit-transform: translateZ(0);
        }
      }
    }
  </style>
</head>
<body>
  <!-- MENSAJE DE AYUDA PARA iOS (solo visible en iPhone/iPad) -->
  <div class="ios-help" id="iosHelp">
    <strong>üì± Instrucciones para iPhone:</strong>
    <ol>
      <li>Presiona el bot√≥n <strong>"üñ®Ô∏è Imprimir"</strong></li>
      <li>En el men√∫, busca <strong>"Thermer"</strong></li>
      <li>Si no aparece, abre la app <strong>Thermer</strong> primero</li>
      <li>Configura Thermer como <strong>impresora predeterminada</strong></li>
      <li>Regresa aqu√≠ e imprime de nuevo</li>
    </ol>
  </div>

  <!-- CONTENEDOR DEL TICKET -->
  <div class="ticket" id="ticket">
    <div class="header">
      <img id="logo" class="logo" src="" alt="Logo" style="display:none">
      <div class="empresa-nombre" id="empresaNombre"></div>
      <div class="empresa-info">
        <div id="empresaNit"></div>
        <div id="empresaDireccion"></div>
        <div id="empresaTelefono"></div>
      </div>
    </div>
    
    <div class="factura-info">
      <div><strong>Factura:</strong><span id="numeroFactura"></span></div>
      <div><strong>Fecha:</strong><span id="fecha"></span></div>
      <div><strong>Cliente:</strong><span id="cliente"></span></div>
    </div>
    
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th class="text-center">Cant</th>
          <th class="text-right">Total</th>
        </tr>
      </thead>
      <tbody id="productosBody"></tbody>
    </table>
    
    <div class="total-section">
      <div class="total-row main">
        <span>TOTAL:</span>
        <span id="total"></span>
      </div>
      <div class="total-row">
        <span>Recibido:</span>
        <span id="recibido"></span>
      </div>
      <div class="total-row">
        <span>Devuelta:</span>
        <span id="devuelta"></span>
      </div>
      <div class="total-row">
        <span>M√©todo:</span>
        <span id="metodoPago"></span>
      </div>
    </div>
    
    <div class="footer">
      <p><strong>¬°Muchas gracias por su compra!</strong></p>
      <p>Vuelva pronto</p>
    </div>
  </div>
  
  <!-- BOTONES -->
  <div class="btn-container">
    <button class="btn btn-print" onclick="imprimirTicket()">
      üñ®Ô∏è Imprimir
    </button>
    <button class="btn btn-rawbt" onclick="imprimirRawBT()" id="btnRawBT" style="display:none">
      üì± RawBT
    </button>
    <button class="btn btn-close" onclick="cerrarVentana()">
      ‚úñÔ∏è Cerrar
    </button>
  </div>
  
  <script>
    // =============================================
    // UTILIDADES
    // =============================================
    function formatNumber(num) {
      return new Intl.NumberFormat('es-CO').format(num);
    }
    
    function esIOS() {
      return /iPhone|iPad|iPod/i.test(navigator.userAgent);
    }
    
    function esAndroid() {
      return /Android/i.test(navigator.userAgent);
    }
    
    function esMovil() {
      return esIOS() || esAndroid();
    }
    
    // =============================================
    // CARGAR TICKET
    // =============================================
    function cargarTicket() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const dataEncoded = urlParams.get('data');
        
        if (!dataEncoded) {
          mostrarError('No se encontraron datos del ticket');
          return;
        }
        
        const dataDecoded = JSON.parse(decodeURIComponent(atob(dataEncoded)));
        
        // Empresa
        document.getElementById('empresaNombre').textContent = dataDecoded.empresa.nombre;
        document.getElementById('empresaNit').textContent = 'NIT: ' + dataDecoded.empresa.nit;
        document.getElementById('empresaDireccion').textContent = dataDecoded.empresa.direccion;
        document.getElementById('empresaTelefono').textContent = 'Tel: ' + dataDecoded.empresa.telefono;
        
        // Logo
        if (dataDecoded.empresa.logo) {
          const logo = document.getElementById('logo');
          logo.src = dataDecoded.empresa.logo;
          logo.style.display = 'block';
          logo.onerror = () => logo.style.display = 'none';
        }
        
        // Factura
        document.getElementById('numeroFactura').textContent = dataDecoded.numeroFactura;
        document.getElementById('fecha').textContent = dataDecoded.fecha;
        document.getElementById('cliente').textContent = dataDecoded.cliente;
        
        // Productos
        const tbody = document.getElementById('productosBody');
        dataDecoded.productos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.nombre}</td>
            <td class="text-center">${p.cantidad}</td>
            <td class="text-right">$${formatNumber(p.subtotal)}</td>
          `;
          tbody.appendChild(tr);
        });
        
        // Totales
        document.getElementById('total').textContent = '$' + formatNumber(dataDecoded.total);
        document.getElementById('recibido').textContent = '$' + formatNumber(dataDecoded.recibido);
        document.getElementById('devuelta').textContent = '$' + formatNumber(dataDecoded.devuelta);
        document.getElementById('metodoPago').textContent = dataDecoded.metodoPago;
        
        // Mostrar bot√≥n RawBT en Android
        if (esAndroid()) {
          document.getElementById('btnRawBT').style.display = 'inline-block';
        }
        
        // Ocultar mensaje iOS en otros dispositivos
        if (!esIOS()) {
          const iosHelp = document.getElementById('iosHelp');
          if (iosHelp) iosHelp.style.display = 'none';
        }
        
        // NO auto-imprimir en m√≥viles (para que el usuario pueda seleccionar Thermer)
        
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error al cargar el ticket', error.message);
      }
    }
    
    // =============================================
    // IMPRIMIR
    // =============================================
    function imprimirTicket() {
      // En iOS, mostrar alerta antes de imprimir
      if (esIOS()) {
        const mensaje = 'üì± En el siguiente men√∫, selecciona "Thermer" como impresora.\n\n' +
                       'Si no aparece Thermer:\n' +
                       '1. Abre la app Thermer\n' +
                       '2. Ve a Configuraci√≥n\n' +
                       '3. Activa "Impresora predeterminada"\n' +
                       '4. Regresa aqu√≠ e imprime de nuevo';
        
        alert(mensaje);
      }
      
      // Abrir di√°logo de impresi√≥n
      window.print();
    }
    
    // =============================================
    // IMPRIMIR CON RAWBT (ANDROID)
    // =============================================
    function imprimirRawBT() {
      try {
        const contenido = generarTextoPlano();
        const encoded = encodeURIComponent(contenido);
        window.location.href = 'rawbt:' + encoded;
        
        setTimeout(() => {
          alert('Si RawBT no se abri√≥, inst√°lalo desde Play Store');
        }, 1000);
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
    
    function generarTextoPlano() {
      const empresa = document.getElementById('empresaNombre').textContent;
      const nit = document.getElementById('empresaNit').textContent;
      const dir = document.getElementById('empresaDireccion').textContent;
      const tel = document.getElementById('empresaTelefono').textContent;
      const fac = document.getElementById('numeroFactura').textContent;
      const fecha = document.getElementById('fecha').textContent;
      const cli = document.getElementById('cliente').textContent;
      const tot = document.getElementById('total').textContent;
      const rec = document.getElementById('recibido').textContent;
      const dev = document.getElementById('devuelta').textContent;
      const met = document.getElementById('metodoPago').textContent;
      
      let prods = '';
      document.querySelectorAll('#productosBody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length === 3) {
          prods += `${tds[0].textContent}\n  ${tds[1].textContent} x ${tds[2].textContent}\n`;
        }
      });
      
      const linea = '='.repeat(42);
      
      return `${centrar(empresa)}\n${centrar(nit)}\n${centrar(dir)}\n${centrar(tel)}\n${linea}\n` +
             `Factura: ${fac}\nFecha: ${fecha}\nCliente: ${cli}\n${linea}\n${prods}${linea}\n` +
             `TOTAL: ${tot}\nRecibido: ${rec}\nDevuelta: ${dev}\nM√©todo: ${met}\n${linea}\n` +
             `${centrar('¬°Gracias por su compra!')}\n\n\n`;
    }
    
    function centrar(txt) {
      const pad = Math.floor((42 - txt.length) / 2);
      return ' '.repeat(Math.max(0, pad)) + txt;
    }
    
    // =============================================
    // CERRAR VENTANA
    // =============================================
    function cerrarVentana() {
      window.close();
      setTimeout(() => {
        if (!window.closed) {
          alert('Cierra esta pesta√±a manualmente');
        }
      }, 500);
    }
    
    // =============================================
    // MOSTRAR ERROR
    // =============================================
    function mostrarError(msg, detalle = '') {
      document.body.innerHTML = `
        <div style="text-align:center;padding:50px;font-family:Arial">
          <h2 style="color:#f44336">‚ö†Ô∏è Error</h2>
          <p style="font-size:16px;margin:20px 0">${msg}</p>
          ${detalle ? `<p style="color:#999;font-size:12px">${detalle}</p>` : ''}
          <button onclick="window.close()" style="margin-top:20px;padding:10px 20px;background:#2196F3;color:white;border:none;border-radius:5px;cursor:pointer">
            Cerrar
          </button>
        </div>
      `;
    }
    
    // Ejecutar al cargar
    window.addEventListener('load', cargarTicket);
  </script>
</body>
</html>
